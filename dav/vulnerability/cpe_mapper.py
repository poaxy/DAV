"""CPE (Common Platform Enumeration) mapping for packages."""

import re
from typing import Optional, Dict, Any


class CPEMapper:
    """Map package information to CPE 2.3 format."""
    
    # Common vendor mappings
    VENDOR_MAP = {
        "apache": "apache",
        "nginx": "nginx",
        "openssl": "openssl",
        "python": "python_software_foundation",
        "python3": "python_software_foundation",
        "node": "nodejs",
        "nodejs": "nodejs",
        "postgresql": "postgresql",
        "mysql": "oracle",
        "mariadb": "mariadb",
        "redis": "redis",
        "docker": "docker",
        "git": "git",
        "curl": "haxx",
        "wget": "gnu",
        "vim": "vim",
        "emacs": "gnu",
        "gcc": "gnu",
        "g++": "gnu",
    }
    
    def package_to_cpe(self, package: Dict[str, str], os_info: Dict[str, Any]) -> Optional[str]:
        """
        Convert package information to CPE 2.3 format.
        
        Args:
            package: Package dictionary with 'name', 'version', etc.
            os_info: OS information dictionary
        
        Returns:
            CPE 2.3 string or None if conversion fails
        """
        package_name = package.get("name", "").lower()
        version = package.get("version", "")
        
        if not package_name or not version:
            return None
        
        # Normalize package name
        package_name = package_name.replace("_", "-").replace(".", "-")
        
        # Determine vendor
        vendor = self._guess_vendor(package_name, os_info)
        
        # Normalize product name
        product = self._normalize_product_name(package_name)
        
        # Normalize version
        normalized_version = self._normalize_version(version)
        
        # CPE 2.3 format: cpe:2.3:a:vendor:product:version:*:*:*:*:*:*:*
        cpe = f"cpe:2.3:a:{vendor}:{product}:{normalized_version}:*:*:*:*:*:*:*"
        
        return cpe
    
    def _guess_vendor(self, package_name: str, os_info: Dict[str, Any]) -> str:
        """
        Guess vendor from package name.
        
        Args:
            package_name: Normalized package name
            os_info: OS information
        
        Returns:
            Vendor name
        """
        # Check vendor map first
        for key, vendor in self.VENDOR_MAP.items():
            if key in package_name:
                return vendor
        
        # Check for common prefixes
        if package_name.startswith("lib"):
            # Library packages - use package name without lib prefix
            base_name = package_name.replace("lib", "", 1)
            return base_name.replace("-", "_")
        
        # Default: use package name as vendor (normalized)
        return package_name.replace("-", "_")
    
    def _normalize_product_name(self, package_name: str) -> str:
        """
        Normalize product name for CPE.
        
        Args:
            package_name: Package name
        
        Returns:
            Normalized product name
        """
        # Remove common prefixes
        name = package_name
        for prefix in ["lib", "python-", "python3-", "node-"]:
            if name.startswith(prefix):
                name = name[len(prefix):]
        
        # Replace hyphens with underscores for CPE compatibility
        name = name.replace("-", "_")
        
        return name
    
    def _normalize_version(self, version: str) -> str:
        """
        Normalize version string for CPE.
        
        Args:
            version: Version string
        
        Returns:
            Normalized version
        """
        # Remove build metadata (everything after +)
        if "+" in version:
            version = version.split("+")[0]
        
        # Remove epoch (everything before :)
        if ":" in version:
            version = version.split(":")[-1]
        
        # Remove trailing non-version characters
        version = re.sub(r'[^0-9.]+$', '', version)
        
        # Ensure at least one digit
        if not re.search(r'\d', version):
            return "*"
        
        return version
