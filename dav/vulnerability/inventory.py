"""Package inventory collection from various package managers."""

import json
import subprocess
from pathlib import Path
from typing import Dict, List, Any

from dav.context import get_os_info


class PackageInventory:
    """Collect installed packages from the system."""
    
    def __init__(self):
        """Initialize package inventory collector."""
        self.os_info = get_os_info()
    
    def collect_all_packages(self) -> Dict[str, Any]:
        """
        Collect all packages from all available managers.
        
        Returns:
            Dictionary with package lists by source:
            {
                "system_packages": [...],
                "python_packages": [...],
                "os_info": {...}
            }
        """
        inventory = {
            "system_packages": [],
            "python_packages": [],
            "os_info": self.os_info
        }
        
        # System packages based on OS
        if self.os_info.get("system") == "Linux":
            distro_id = self.os_info.get("distribution_id", "").lower()
            
            if distro_id in ["ubuntu", "debian"]:
                inventory["system_packages"] = self._collect_dpkg()
            elif distro_id in ["fedora", "rhel", "centos", "rocky", "almalinux"]:
                inventory["system_packages"] = self._collect_rpm()
        
        # Language packages
        inventory["python_packages"] = self._collect_python()
        
        return inventory
    
    def _collect_dpkg(self) -> List[Dict[str, str]]:
        """
        Collect Debian/Ubuntu packages using dpkg.
        
        Returns:
            List of package dictionaries
        """
        try:
            result = subprocess.run(
                ["dpkg-query", "-W", "-f=${Package}|${Version}|${Architecture}\n"],
                capture_output=True,
                text=True,
                timeout=30,
                check=False
            )
            
            if result.returncode != 0:
                return []
            
            packages = []
            for line in result.stdout.strip().split('\n'):
                if '|' in line:
                    parts = line.split('|')
                    if len(parts) >= 2:
                        packages.append({
                            "name": parts[0],
                            "version": parts[1],
                            "architecture": parts[2] if len(parts) > 2 else "unknown",
                            "manager": "dpkg",
                            "source": "system"
                        })
            return packages
        except (subprocess.TimeoutExpired, FileNotFoundError, Exception):
            return []
    
    def _collect_rpm(self) -> List[Dict[str, str]]:
        """
        Collect RPM packages using rpm.
        
        Returns:
            List of package dictionaries
        """
        try:
            result = subprocess.run(
                ["rpm", "-qa", "--queryformat", "%{NAME}|%{VERSION}|%{ARCH}\n"],
                capture_output=True,
                text=True,
                timeout=30,
                check=False
            )
            
            if result.returncode != 0:
                return []
            
            packages = []
            for line in result.stdout.strip().split('\n'):
                if '|' in line:
                    parts = line.split('|')
                    if len(parts) >= 2:
                        packages.append({
                            "name": parts[0],
                            "version": parts[1],
                            "architecture": parts[2] if len(parts) > 2 else "unknown",
                            "manager": "rpm",
                            "source": "system"
                        })
            return packages
        except (subprocess.TimeoutExpired, FileNotFoundError, Exception):
            return []
    
    def _collect_python(self) -> List[Dict[str, str]]:
        """
        Collect Python packages using pip.
        
        Returns:
            List of package dictionaries
        """
        try:
            result = subprocess.run(
                ["pip", "list", "--format", "json"],
                capture_output=True,
                text=True,
                timeout=30,
                check=False
            )
            
            if result.returncode != 0:
                return []
            
            packages_data = json.loads(result.stdout)
            return [{
                "name": p["name"],
                "version": p["version"],
                "manager": "pip",
                "source": "python"
            } for p in packages_data]
        except (subprocess.TimeoutExpired, FileNotFoundError, json.JSONDecodeError, Exception):
            return []
